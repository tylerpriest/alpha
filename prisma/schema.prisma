// AlphaIntel - AI Knowledge Base for VC/PE Firms
// Multi-tenant SaaS with full audit trail

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearch", "fullTextIndex"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// AUTHENTICATION & USERS
// ============================================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

enum UserRole {
  OWNER
  ADMIN
  PARTNER
  PRINCIPAL
  ASSOCIATE
  ANALYST
  VIEWER
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  name          String?
  image         String?
  passwordHash  String?
  role          UserRole  @default(ANALYST)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  accounts      Account[]
  sessions      Session[]
  memberships   OrganizationMember[]
  documents     Document[]
  conversations Conversation[]
  messages      Message[]
  deals         Deal[]
  activities    Activity[]
  comments      Comment[]
  apiKeys       ApiKey[]

  @@index([email])
}

// ============================================
// ORGANIZATIONS (Multi-Tenancy)
// ============================================

enum OrganizationType {
  VENTURE_CAPITAL
  PRIVATE_EQUITY
  GROWTH_EQUITY
  FAMILY_OFFICE
  CORPORATE_VC
  FUND_OF_FUNDS
  OTHER
}

enum SubscriptionTier {
  FREE
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

model Organization {
  id               String            @id @default(cuid())
  name             String
  slug             String            @unique
  logo             String?
  website          String?
  type             OrganizationType  @default(VENTURE_CAPITAL)
  description      String?
  aum              Decimal?          @db.Decimal(18, 2) // Assets Under Management
  foundedYear      Int?
  headquarters     String?

  // Subscription & Billing
  subscriptionTier SubscriptionTier  @default(FREE)
  stripeCustomerId String?           @unique
  subscriptionId   String?
  subscriptionEnd  DateTime?

  // Usage limits
  storageUsed      BigInt            @default(0) // bytes
  storageLimit     BigInt            @default(1073741824) // 1GB default
  queryCount       Int               @default(0)
  queryLimit       Int               @default(1000)

  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  // Relations
  members          OrganizationMember[]
  documents        Document[]
  folders          Folder[]
  conversations    Conversation[]
  deals            Deal[]
  portfolioCompanies PortfolioCompany[]
  funds            Fund[]
  integrations     Integration[]
  activities       Activity[]
  invitations      Invitation[]
  apiKeys          ApiKey[]
  collections      Collection[]
  tags             Tag[]

  @@index([slug])
  @@index([stripeCustomerId])
}

model OrganizationMember {
  id             String       @id @default(cuid())
  userId         String
  organizationId String
  role           UserRole     @default(ANALYST)
  joinedAt       DateTime     @default(now())
  invitedBy      String?

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@index([organizationId])
}

model Invitation {
  id             String       @id @default(cuid())
  email          String
  organizationId String
  role           UserRole     @default(ANALYST)
  token          String       @unique
  expiresAt      DateTime
  invitedBy      String
  createdAt      DateTime     @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([organizationId])
}

// ============================================
// KNOWLEDGE BASE & DOCUMENTS
// ============================================

enum DocumentType {
  PDF
  WORD
  EXCEL
  POWERPOINT
  TEXT
  MARKDOWN
  HTML
  EMAIL
  TRANSCRIPT
  FINANCIAL_MODEL
  PITCH_DECK
  TERM_SHEET
  LEGAL_DOC
  RESEARCH_REPORT
  MEMO
  OTHER
}

enum DocumentStatus {
  UPLOADING
  PROCESSING
  INDEXED
  FAILED
  ARCHIVED
}

model Folder {
  id             String       @id @default(cuid())
  name           String
  description    String?
  parentId       String?
  organizationId String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  parent       Folder?      @relation("FolderHierarchy", fields: [parentId], references: [id])
  children     Folder[]     @relation("FolderHierarchy")
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  documents    Document[]

  @@index([organizationId])
  @@index([parentId])
}

model Collection {
  id             String       @id @default(cuid())
  name           String
  description    String?
  color          String       @default("#3B82F6")
  icon           String       @default("folder")
  organizationId String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  documents    DocumentCollection[]

  @@index([organizationId])
}

model Document {
  id             String         @id @default(cuid())
  title          String
  description    String?
  fileName       String
  fileType       String
  fileSize       BigInt
  mimeType       String
  storageKey     String         @unique // S3/storage key
  type           DocumentType   @default(OTHER)
  status         DocumentStatus @default(UPLOADING)

  // Content
  content        String?        @db.Text // Extracted text
  summary        String?        @db.Text // AI-generated summary
  metadata       Json?          // Flexible metadata

  // Ownership
  organizationId String
  folderId       String?
  uploadedById   String

  // Processing
  chunkCount     Int            @default(0)
  tokenCount     Int            @default(0)
  processingError String?
  processedAt    DateTime?

  // Timestamps
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  // Relations
  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  folder       Folder?       @relation(fields: [folderId], references: [id])
  uploadedBy   User          @relation(fields: [uploadedById], references: [id])
  chunks       DocumentChunk[]
  collections  DocumentCollection[]
  tags         DocumentTag[]
  deals        DealDocument[]
  activities   Activity[]

  @@index([organizationId])
  @@index([folderId])
  @@index([uploadedById])
  @@index([status])
  @@index([type])
}

model DocumentCollection {
  documentId   String
  collectionId String
  addedAt      DateTime @default(now())

  document   Document   @relation(fields: [documentId], references: [id], onDelete: Cascade)
  collection Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)

  @@id([documentId, collectionId])
}

model Tag {
  id             String       @id @default(cuid())
  name           String
  color          String       @default("#6B7280")
  organizationId String
  createdAt      DateTime     @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  documents    DocumentTag[]

  @@unique([organizationId, name])
  @@index([organizationId])
}

model DocumentTag {
  documentId String
  tagId      String
  addedAt    DateTime @default(now())

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  tag      Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([documentId, tagId])
}

// Vector embeddings for semantic search
model DocumentChunk {
  id         String   @id @default(cuid())
  documentId String
  content    String   @db.Text
  chunkIndex Int
  tokenCount Int

  // Vector embedding stored as array (for pgvector)
  embedding  Float[]  // 1536 dimensions for OpenAI ada-002

  // Metadata for retrieval
  pageNumber Int?
  section    String?

  createdAt  DateTime @default(now())

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([chunkIndex])
}

// ============================================
// AI CONVERSATIONS & CHAT
// ============================================

enum ConversationType {
  GENERAL
  DEAL_ANALYSIS
  DUE_DILIGENCE
  MARKET_RESEARCH
  PORTFOLIO_REVIEW
  DOCUMENT_QA
}

model Conversation {
  id             String           @id @default(cuid())
  title          String?
  type           ConversationType @default(GENERAL)
  organizationId String
  userId         String

  // Context linking
  dealId         String?
  portfolioId    String?

  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  organization Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User             @relation(fields: [userId], references: [id])
  deal         Deal?            @relation(fields: [dealId], references: [id])
  portfolio    PortfolioCompany? @relation(fields: [portfolioId], references: [id])
  messages     Message[]

  @@index([organizationId])
  @@index([userId])
  @@index([dealId])
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}

model Message {
  id             String      @id @default(cuid())
  conversationId String
  role           MessageRole
  content        String      @db.Text

  // For assistant messages
  model          String?     // e.g., "gpt-4", "claude-3"
  tokens         Int?

  // Source references
  sources        Json?       // Referenced document chunks

  // User who sent (for user messages)
  userId         String?

  createdAt      DateTime    @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User?        @relation(fields: [userId], references: [id])

  @@index([conversationId])
  @@index([userId])
}

// ============================================
// DEAL FLOW & PIPELINE
// ============================================

enum DealStage {
  SOURCED
  INITIAL_REVIEW
  FIRST_MEETING
  DEEP_DIVE
  DUE_DILIGENCE
  TERM_SHEET
  LEGAL
  CLOSED_WON
  CLOSED_LOST
  PASSED
}

enum DealSource {
  INBOUND
  OUTBOUND
  REFERRAL
  PORTFOLIO
  CONFERENCE
  COLD_OUTREACH
  OTHER
}

model Deal {
  id               String       @id @default(cuid())
  name             String
  description      String?      @db.Text
  website          String?
  stage            DealStage    @default(SOURCED)
  source           DealSource   @default(INBOUND)

  // Company Info
  companyName      String
  industry         String?
  sector           String?
  subSector        String?
  location         String?
  foundedYear      Int?
  employeeCount    Int?

  // Financials
  revenue          Decimal?     @db.Decimal(18, 2)
  revenueGrowth    Decimal?     @db.Decimal(5, 2) // percentage
  grossMargin      Decimal?     @db.Decimal(5, 2)
  burnRate         Decimal?     @db.Decimal(18, 2)
  runway           Int?         // months

  // Deal Terms
  askAmount        Decimal?     @db.Decimal(18, 2)
  preMoneyVal      Decimal?     @db.Decimal(18, 2)
  proposedOwnership Decimal?    @db.Decimal(5, 2)

  // Investment Decision
  investmentThesis String?      @db.Text
  risks            String?      @db.Text
  passReason       String?      @db.Text

  // Ownership
  organizationId   String
  leadPartnerId    String?
  fundId           String?

  // Scoring
  aiScore          Decimal?     @db.Decimal(3, 2) // 0-10
  teamScore        Decimal?     @db.Decimal(3, 2)
  marketScore      Decimal?     @db.Decimal(3, 2)
  productScore     Decimal?     @db.Decimal(3, 2)

  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  closedAt         DateTime?

  organization Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  leadPartner  User?            @relation(fields: [leadPartnerId], references: [id])
  fund         Fund?            @relation(fields: [fundId], references: [id])
  documents    DealDocument[]
  conversations Conversation[]
  contacts     DealContact[]
  activities   Activity[]
  comments     Comment[]
  portfolio    PortfolioCompany?

  @@index([organizationId])
  @@index([stage])
  @@index([leadPartnerId])
  @@index([fundId])
}

model DealDocument {
  dealId     String
  documentId String
  category   String?  // e.g., "pitch_deck", "financials", "legal"
  addedAt    DateTime @default(now())

  deal     Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)
  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@id([dealId, documentId])
}

model DealContact {
  id       String  @id @default(cuid())
  dealId   String
  name     String
  title    String?
  email    String?
  phone    String?
  linkedin String?
  isPrimary Boolean @default(false)
  notes    String? @db.Text

  deal Deal @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@index([dealId])
}

// ============================================
// PORTFOLIO MANAGEMENT
// ============================================

model Fund {
  id             String       @id @default(cuid())
  name           String
  vintage        Int          // Year
  size           Decimal      @db.Decimal(18, 2)
  currency       String       @default("USD")
  status         String       @default("active") // active, closed, fundraising
  focusAreas     String[]

  organizationId String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  organization Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  deals        Deal[]
  investments  Investment[]
  portfolioCompanies PortfolioCompany[]

  @@index([organizationId])
}

model PortfolioCompany {
  id             String       @id @default(cuid())
  name           String
  website        String?
  description    String?      @db.Text
  industry       String?
  sector         String?
  location       String?
  foundedYear    Int?

  // Current Status
  status         String       @default("active") // active, exited, written_off
  boardSeat      Boolean      @default(false)

  // Ownership
  organizationId String
  fundId         String?
  dealId         String?      @unique

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  fund         Fund?        @relation(fields: [fundId], references: [id])
  deal         Deal?        @relation(fields: [dealId], references: [id])
  investments  Investment[]
  metrics      PortfolioMetric[]
  conversations Conversation[]

  @@index([organizationId])
  @@index([fundId])
  @@index([status])
}

model Investment {
  id              String           @id @default(cuid())
  portfolioId     String
  fundId          String
  round           String           // Seed, Series A, etc.
  investedAmount  Decimal          @db.Decimal(18, 2)
  valuation       Decimal?         @db.Decimal(18, 2)
  ownership       Decimal          @db.Decimal(5, 4) // percentage
  investedDate    DateTime

  // Current value tracking
  currentValue    Decimal?         @db.Decimal(18, 2)
  moic            Decimal?         @db.Decimal(6, 2) // Multiple on Invested Capital
  irr             Decimal?         @db.Decimal(5, 2) // Internal Rate of Return

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  portfolio PortfolioCompany @relation(fields: [portfolioId], references: [id], onDelete: Cascade)
  fund      Fund             @relation(fields: [fundId], references: [id])

  @@index([portfolioId])
  @@index([fundId])
}

model PortfolioMetric {
  id          String           @id @default(cuid())
  portfolioId String
  date        DateTime

  // Financial Metrics
  revenue     Decimal?         @db.Decimal(18, 2)
  arr         Decimal?         @db.Decimal(18, 2) // Annual Recurring Revenue
  mrr         Decimal?         @db.Decimal(18, 2) // Monthly Recurring Revenue
  grossMargin Decimal?         @db.Decimal(5, 2)
  burnRate    Decimal?         @db.Decimal(18, 2)
  runway      Int?             // months
  cash        Decimal?         @db.Decimal(18, 2)

  // Growth Metrics
  customers   Int?
  employees   Int?
  nrr         Decimal?         @db.Decimal(5, 2) // Net Revenue Retention
  churn       Decimal?         @db.Decimal(5, 2)
  cac         Decimal?         @db.Decimal(18, 2) // Customer Acquisition Cost
  ltv         Decimal?         @db.Decimal(18, 2) // Lifetime Value

  notes       String?          @db.Text
  createdAt   DateTime         @default(now())

  portfolio PortfolioCompany @relation(fields: [portfolioId], references: [id], onDelete: Cascade)

  @@index([portfolioId])
  @@index([date])
}

// ============================================
// ACTIVITY & AUDIT TRAIL
// ============================================

enum ActivityType {
  // Documents
  DOCUMENT_UPLOADED
  DOCUMENT_VIEWED
  DOCUMENT_DOWNLOADED
  DOCUMENT_DELETED
  DOCUMENT_SHARED

  // Deals
  DEAL_CREATED
  DEAL_UPDATED
  DEAL_STAGE_CHANGED
  DEAL_CLOSED

  // AI
  AI_QUERY
  AI_ANALYSIS

  // Users
  USER_INVITED
  USER_JOINED
  USER_REMOVED

  // System
  EXPORT_CREATED
  INTEGRATION_CONNECTED
  SETTINGS_CHANGED
}

model Activity {
  id             String       @id @default(cuid())
  type           ActivityType
  description    String
  metadata       Json?

  organizationId String
  userId         String?
  documentId     String?
  dealId         String?

  ipAddress      String?
  userAgent      String?

  createdAt      DateTime     @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User?        @relation(fields: [userId], references: [id])
  document     Document?    @relation(fields: [documentId], references: [id])
  deal         Deal?        @relation(fields: [dealId], references: [id])

  @@index([organizationId])
  @@index([userId])
  @@index([type])
  @@index([createdAt])
}

model Comment {
  id        String   @id @default(cuid())
  content   String   @db.Text
  dealId    String?
  userId    String
  parentId  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  deal   Deal?    @relation(fields: [dealId], references: [id], onDelete: Cascade)
  user   User     @relation(fields: [userId], references: [id])
  parent Comment? @relation("CommentReplies", fields: [parentId], references: [id])
  replies Comment[] @relation("CommentReplies")

  @@index([dealId])
  @@index([userId])
}

// ============================================
// INTEGRATIONS & API
// ============================================

model Integration {
  id             String       @id @default(cuid())
  organizationId String
  provider       String       // e.g., "affinity", "carta", "slack"
  status         String       @default("pending") // pending, active, failed

  // OAuth tokens (encrypted in practice)
  accessToken    String?      @db.Text
  refreshToken   String?      @db.Text
  tokenExpiry    DateTime?

  config         Json?
  lastSyncAt     DateTime?

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, provider])
  @@index([organizationId])
}

model ApiKey {
  id             String       @id @default(cuid())
  name           String
  keyHash        String       @unique // Store hashed key
  keyPrefix      String       // First 8 chars for identification

  organizationId String
  createdById    String

  scopes         String[]     // e.g., ["documents:read", "deals:write"]
  lastUsedAt     DateTime?
  expiresAt      DateTime?

  createdAt      DateTime     @default(now())
  revokedAt      DateTime?

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy    User         @relation(fields: [createdById], references: [id])

  @@index([organizationId])
  @@index([keyPrefix])
}
